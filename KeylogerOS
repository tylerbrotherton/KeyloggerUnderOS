#include <windows.h>
#include <iostream>
#include <fstream>
#include <ctime>
#include <string>

// Define the log file name
const std::string LOG_FILE = "keystrokes.log";

// Define the allowed window title
const std::string allowed_window_title = "Your Game Window Title";

// Function to log keystrokes
void log_key(const std::string& key) {
    std::time_t now = std::time(nullptr);
    char buffer[26];
    std::strftime(buffer, sizeof(buffer), "%Y-%m-%d %H:%M:%S", std::localtime(&now));

    std::ofstream log_file(LOG_FILE, std::ios::app);
    if (log_file.is_open()) {
        log_file << buffer << " | " << key << "\n";
        log_file.close();
    }
}

// Function to check if the game window is active
bool is_game_window_active() {
    HWND hwnd = GetForegroundWindow();
    char window_title[256];
    GetWindowTextA(hwnd, window_title, sizeof(window_title));
    std::string title(window_title);
    return title == allowed_window_title;
}

// Keyboard hook procedure
LRESULT CALLBACK KeyboardProc(int nCode, WPARAM wParam, LPARAM lParam) {
    if (nCode == HC_ACTION) {
        if (wParam == WM_KEYDOWN || wParam == WM_SYSKEYDOWN) {
            KBDLLHOOKSTRUCT* pKeyboard = (KBDLLHOOKSTRUCT*)lParam;
            if (is_game_window_active()) {
                std::string key;
                switch (pKeyboard->vkCode) {
                    case VK_RETURN: key = "ENTER"; break;
                    case VK_BACK: key = "BACKSPACE"; break;
                    case VK_TAB: key = "TAB"; break;
                    case VK_SPACE: key = "SPACE"; break;
                    case VK_SHIFT: key = "SHIFT"; break;
                    case VK_CONTROL: key = "CTRL"; break;
                    case VK_MENU: key = "ALT"; break;
                    case VK_CAPITAL: key = "CAPS LOCK"; break;
                    case VK_ESCAPE: key = "ESC"; break;
                    case VK_DELETE: key = "DELETE"; break;
                    case VK_LEFT: key = "LEFT ARROW"; break;
                    case VK_RIGHT: key = "RIGHT ARROW"; break;
                    case VK_UP: key = "UP ARROW"; break;
                    case VK_DOWN: key = "DOWN ARROW"; break;
                    default:
                        if (pKeyboard->vkCode >= 'A' && pKeyboard->vkCode <= 'Z') {
                            key = static_cast<char>(pKeyboard->vkCode);
                        } else if (pKeyboard->vkCode >= '0' && pKeyboard->vkCode <= '9') {
                            key = static_cast<char>(pKeyboard->vkCode);
                        } else {
                            key = "UNKNOWN";
                        }
                        break;
                }
                log_key(key);
            }
        }
    }
    return CallNextHookEx(NULL, nCode, wParam, lParam);
}

int main() {
    std::cout << "Friendly Keylogger Running..." << std::endl;
    std::cout << "Only log keys from the window titled '" << allowed_window_title << "'." << std::endl;
    std::cout << "Press CTRL+C to stop." << std::endl;

    HHOOK hKeyboardHook = SetWindowsHookEx(WH_KEYBOARD_LL, KeyboardProc, NULL, 0);
    if (hKeyboardHook == NULL) {
        std::cerr << "Failed to install keyboard hook!" << std::endl;
        return 1;
    }

    MSG msg;
    while (GetMessage(&msg, NULL, 0, 0)) {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
    }

    UnhookWindowsHookEx(hKeyboardHook);
    return 0;
}
